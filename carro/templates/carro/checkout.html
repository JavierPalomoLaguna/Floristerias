{% extends 'tienda/base_tienda.html' %}

{% block title %}Checkout - Confirmar Pedido - Tienda CVS{% endblock %}

{% block meta_description %}Confirma tu pedido y selecciona m√©todo de pago.{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-tienda">
    <div class="container text-center">
        <h1 class="display-4 fw-bold mb-3">‚úÖ Confirmar Pedido</h1>
        <p class="lead">Revisa y confirma tu compra</p>
    </div>
</section>

<section class="container my-5">
    {% if carro %}
    <div class="row">
        <!-- Resumen del Pedido -->
        <div class="col-lg-8 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-shopping-bag me-2"></i>Resumen del Pedido
                    </h4>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for key, item in carro.items %}
                        <div class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <div class="d-flex align-items-center">
                                <img src="{{ item.imagen }}" 
                                     alt="{{ item.nombre }}" 
                                     class="rounded-3 me-3"
                                     style="width: 60px; height: 60px; object-fit: cover;">
                                <div>
                                    <h6 class="mb-1">{{ item.nombre }}</h6>
                                    <small class="text-muted">{{ item.cantidad }} x {{ item.precio|floatformat:2 }} ‚Ç¨</small>
                                </div>
                            </div>
                            <span class="fw-bold text-success">{{ item.total|floatformat:2 }} ‚Ç¨</span>
                        </div>
                        {% endfor %}
                        
                        <!-- Gastos de env√≠o -->
                        <div class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <div>
                                <h6 class="mb-1">Gastos de env√≠o</h6>
                                {% if envio_gratis_carro %}
                                <small class="text-success">
                                    <i class="fas fa-check-circle me-1"></i>Env√≠o gratis aplicado
                                </small>
                                {% endif %}
                            </div>
                            <span class="fw-bold">
                                {% if envio_gratis_carro %}
                                <span class="text-success">0.00 ‚Ç¨</span>
                                {% else %}
                                {{ gastos_envio_carro|floatformat:2 }} ‚Ç¨
                                {% endif %}
                            </span>
                        </div>
                        
                        <!-- Informaci√≥n env√≠o gratis -->
                        {% if not envio_gratis_carro %}
                        <div class="list-group-item bg-light py-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle text-primary me-2"></i>
                                <small class="text-muted">
                                    ¬°Te faltan <strong>{{ falta_para_envio_gratis|floatformat:2 }} ‚Ç¨</strong> 
                                    para env√≠o gratis!
                                    <br>
                                    <em>(En pedidos superiores a {{ umbral_envio_gratis|floatformat:2 }} ‚Ç¨)</em>
                                </small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Confirmaci√≥n -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-credit-card me-2"></i>Total del Pedido
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Total -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="fs-5 fw-bold">Total:</span>
                        <strong class="fs-4 text-success">{{ total_con_envio_carro|floatformat:2 }} ‚Ç¨</strong>
                    </div>

                    <!-- M√©todo de Pago -->
                    {% if request.session.cliente_id %}
                    <form method="post" action="{% url 'confirmar_pedido' %}">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label for="metodo_pago" class="form-label fw-bold">
                                <i class="fas fa-wallet me-2"></i>M√©todo de pago:
                            </label>
                            <select name="metodo_pago" id="metodo_pago" class="form-select" required>
                                <option value="">Selecciona m√©todo...</option>
                                <option value="tarjeta">üí≥ Tarjeta de Cr√©dito/D√©bito</option>
                                <option value="bizum">üì± Bizum</option>                                
                            </select>
                        </div>

                        <!-- Bot√≥n Confirmar -->
                        <button type="submit" class="btn btn-primario btn-lg w-100 mb-3">
                            <i class="fas fa-check-circle me-2"></i>Confirmar Pedido
                        </button>

                        <!-- Editar datos -->
                        <a href="{% url 'editar_datos_cliente' %}" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-edit me-2"></i>Modificar Datos
                        </a>
                    </form>
                    {% else %}
                    <!-- Usuario no logueado -->
                    <div class="text-center">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Para continuar, inicia sesi√≥n o reg√≠strate
                        </div>
                        <a href="{% url 'tramitar_pedido' %}" class="btn btn-primario btn-lg w-100">
                            <i class="fas fa-user me-2"></i>Iniciar Sesi√≥n / Registrarse
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Carrito vac√≠o -->
    <div class="text-center py-5">
        <div class="card border-0 shadow-sm">
            <div class="card-body py-5">
                <i class="fas fa-shopping-cart fa-4x text-muted mb-4"></i>
                <h3 class="text-muted mb-3">Tu carrito est√° vac√≠o</h3>
                <p class="text-muted mb-4">No hay productos para confirmar el pedido.</p>
                <a href="{% url 'tienda' %}" class="btn btn-primario btn-lg">
                    <i class="fas fa-store me-2"></i>Ir a la Tienda
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Mensajes -->
    {% if messages %}
    <div class="mt-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <i class="fas 
                {% if message.tags == 'success' %}fa-check-circle
                {% elif message.tags == 'error' %}fa-exclamation-circle
                {% elif message.tags == 'warning' %}fa-exclamation-triangle
                {% else %}fa-info-circle{% endif %} 
                me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</section>
{% endblock %}